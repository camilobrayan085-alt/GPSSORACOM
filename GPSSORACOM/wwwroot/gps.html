<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GPS Soracom — Envío Automático</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Segoe UI", Roboto, Arial;
            background: #f6f8fb;
            padding: 18px;
        }

        .card {
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 6px 20px rgba(20,30,60,0.06);
        }

        .btn-lg {
            padding: .75rem 1.25rem;
            font-size: 1.05rem;
        }

        #status {
            font-weight: 600;
        }

        #log {
            max-height: 200px;
            overflow: auto;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
        }

        small.muted {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="card">
                    <h3 class="mb-1">📡 Envío de ubicación (Soracom)</h3>
                    <p class="muted mb-3">Presiona Iniciar para que este teléfono envíe su ubicación periódicamente a tu servidor.</p>

                    <div class="mb-3">
                        <label class="form-label">IMEI / Identificador</label>
                        <input id="imei" class="form-control" placeholder="8942310923000264914" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Endpoint (POST)</label>
                        <input id="endpoint" class="form-control" value="https://gpssoracom.onrender.com/api/gps/save" />
                    </div>

                    <div class="mb-3 row gx-2">
                        <div class="col-6">
                            <label class="form-label">Intervalo (segundos)</label>
                            <input id="interval" type="number" class="form-control" value="5" min="1" />
                        </div>
                        <div class="col-6">
                            <label class="form-label">Precisión</label>
                            <select id="highAcc" class="form-select">
                                <option value="true" selected>Alta (GPS)</option>
                                <option value="false">Baja (Ahorro batería)</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button id="btnStart" class="btn btn-success btn-lg">Iniciar GPS</button>
                        <button id="btnStop" class="btn btn-outline-danger btn-lg" disabled>Detener</button>
                        <button id="btnTest" class="btn btn-outline-primary ms-auto">Enviar prueba</button>
                    </div>

                    <hr />

                    <div class="mb-2">
                        <div>Estado: <span id="status" class="text-success">Detenido</span></div>
                        <div>Última posición: <span id="lastPos">—</span></div>
                        <div>Último envío: <span id="lastSend">—</span></div>
                        <div id="wakeLockStatus" class="mt-1 small muted">Wake Lock: no activo</div>
                    </div>

                    <div class="mt-3">
                        <div id="log"></div>
                    </div>

                    <p class="mt-3 small muted">Nota: si cierras la pestaña o apagas pantalla, la página dejará de enviar ubicación. Para rastreo 24/7 necesitas una app nativa.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
  let watchId = null, sendInterval = null, lastPosition = null, wakeLock = null, sending = false;
  const btnStart=document.getElementById('btnStart'), btnStop=document.getElementById('btnStop'), btnTest=document.getElementById('btnTest');
  const statusEl=document.getElementById('status'), lastPosEl=document.getElementById('lastPos'), lastSendEl=document.getElementById('lastSend');
  const logEl=document.getElementById('log'), wakeLockStatus=document.getElementById('wakeLockStatus');

  function log(msg){ const time=new Date().toLocaleTimeString(); logEl.innerHTML=`[${time}] ${msg}<br>`+logEl.innerHTML; }

  async function requestWakeLock(){
    if(!('wakeLock' in navigator)){ wakeLockStatus.innerText='Wake Lock: no soportado'; return; }
    try{ wakeLock=await navigator.wakeLock.request('screen'); wakeLockStatus.innerText='Wake Lock: activo';
      document.addEventListener('visibilitychange', async()=>{ if(document.visibilityState==='visible' && !wakeLock) wakeLock=await navigator.wakeLock.request('screen'); });
      wakeLock.addEventListener('release',()=>{ wakeLock=null; wakeLockStatus.innerText='Wake Lock: liberado'; log('Wake Lock liberado'); });
    } catch(e){ wakeLockStatus.innerText='Wake Lock: error'; log('Error Wake Lock: '+e?.message); }
  }

  async function releaseWakeLock(){ if(wakeLock){ try{await wakeLock.release();}catch(e){} wakeLock=null; wakeLockStatus.innerText='Wake Lock: no activo'; } }

  function startWatching(){
    const highAcc=document.getElementById('highAcc').value==='true';
    if(!('geolocation' in navigator)){ alert('Geolocalización no soportada'); return; }
    try{
      watchId=navigator.geolocation.watchPosition(pos=>{ lastPosition=pos; lastPosEl.innerText=`${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)} (acc ${Math.round(pos.coords.accuracy)}m)`; log(`GPS: ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`); },
      err=>{ log('Error geolocalización: '+err.message); }, { enableHighAccuracy:highAcc, maximumAge:3000, timeout:10000 });
      log('watchPosition iniciado (ID:'+watchId+')');
    }catch(e){ log('watchPosition no disponible: '+e.message); }
    const seconds=Math.max(1,parseInt(document.getElementById('interval').value||'5',10));
    sendInterval=setInterval(()=>{ if(lastPosition) sendPosition(lastPosition); else navigator.geolocation.getCurrentPosition(pos=>{ lastPosition=pos; sendPosition(pos); }, err=>log('Fallback GPS error: '+err.message), { enableHighAccuracy:highAcc, timeout:10000 }); }, seconds*1000);
  }

  function stopWatching(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; } if(sendInterval){ clearInterval(sendInterval); sendInterval=null; } lastPosition=null; lastPosEl.innerText='—'; }

  async function sendPosition(position){
    if(sending) return; sending=true;
    const imei=(document.getElementById('imei').value||'').trim();
    const endpoint=(document.getElementById('endpoint').value||'').trim();
    if(!endpoint){ log('No hay endpoint'); sending=false; return; }
    const payload={ imei:imei||null, lat:position.coords.latitude, lng:position.coords.longitude, accuracy:position.coords.accuracy, speed:position.coords.speed??null, heading:position.coords.heading??null, timestamp:new Date(position.timestamp).toISOString() };
    try{
      const r=await fetch(endpoint,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(!r.ok){ const text=await r.text().catch(()=>null); log(`Error envío (${r.status}): ${text??r.statusText}`); } else { lastSendEl.innerText=new Date().toLocaleTimeString(); log('Envío OK → '+payload.lat.toFixed(6)+', '+payload.lng.toFixed(6)); }
    }catch(err){ log('Error enviando: '+(err.message||err)); } finally{ sending=false; }
  }

  btnStart.addEventListener('click', async()=>{
    if(statusEl.innerText==='Enviando') return;
    try{ await requestWakeLock(); startWatching(); statusEl.innerText='Enviando'; btnStart.disabled=true; btnStop.disabled=false; log('Proceso iniciado.'); }catch(err){ log('No se pudo iniciar: '+err?.message); }
  });

  btnStop.addEventListener('click',async()=>{ stopWatching(); await releaseWakeLock(); statusEl.innerText='Detenido'; btnStart.disabled=false; btnStop.disabled=true; log('Proceso detenido.'); });

  btnTest.addEventListener('click',()=>{ navigator.geolocation.getCurrentPosition(pos=>{ lastPosition=pos; sendPosition(pos); }, err=>alert('Error GPS: '+err.message), { enableHighAccuracy:true, timeout:10000 }); });

  window.addEventListener('beforeunload',async()=>{ await releaseWakeLock(); });

  log('Interfaz lista. Ingresa IMEI, Endpoint e inicia cuando estés listo.');
    </script>
</body>
</html>
